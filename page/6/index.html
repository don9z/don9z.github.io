<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:300,300italic,400,400italic,700,700italic|Old+Standard+TT:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.zhengdong.me","root":"/","scheme":"Gemini","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":{"disqus":null}},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Extra Cookies">
<meta property="og:url" content="http://blog.zhengdong.me/page/6/index.html">
<meta property="og:site_name" content="Extra Cookies">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dong Zheng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.zhengdong.me/page/6/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Extra Cookies</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-17531526-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-17531526-2');
      }
    </script>






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Extra Cookies</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">By Dong ZHENG</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dong Zheng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="http://zhengdong.me/" title="About → http:&#x2F;&#x2F;zhengdong.me" rel="noopener" target="_blank"><i class="fa fa-user fa-fw"></i>About</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://feeds.feedburner.com/ExtraCookies" title="RSS → http:&#x2F;&#x2F;feeds.feedburner.com&#x2F;ExtraCookies" rel="noopener" target="_blank"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.zhengdong.me/2014/02/26/the-hadoop-2-dot-x-running-a-yarn-job-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dong Zheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Extra Cookies">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2014/02/26/the-hadoop-2-dot-x-running-a-yarn-job-2/" class="post-title-link" itemprop="url">The Hadoop 2.x - Running a YARN Job (2)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2014-02-26 00:01:00" itemprop="dateCreated datePublished" datetime="2014-02-26T00:01:00+08:00">2014-02-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In <a href="/2014/02/25/the-hadoop-2-dot-x-running-a-yarn-job-1/">last blog post</a>, The job <code>Client</code> has been created and initialized.</p>
<p>This post will discuss on how does <code>Client</code> do to deploy the job to hadoop cluster.</p>
<p>Code snippets will be full of this post, to not confuse you, all comments added by me begin with <code>//**</code> instead of <code>//</code> or <code>/*</code> and the code can be cloned from <a target="_blank" rel="noopener" href="http://git.apache.org/hadoop-common.git/">Apache Git Repository</a>, commit id is <code>2e01e27e5ba4ece19650484f646fac42596250ce</code>.</p>
<h2 id="the-resource-manager-proxy">The Resource Manager Proxy</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L330</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException, YarnException </span>&#123;</span><br><span class="line"></span><br><span class="line">  LOG.info(<span class="string">&quot;Running Client&quot;</span>);</span><br><span class="line">  yarnClient.start();</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>At first, the <code>start</code> method of <code>yarnClient</code> is invoked. In <a href="/2014/02/25/the-hadoop-2-dot-x-running-a-yarn-job-1/">last blog post</a> we know, the <code>yarnClient</code> is actually a <code>YarnClientImpl</code> instance, but since it and its super <code>YarnClient</code> don't have the <code>start</code> interface implemented, the code path goes to <code>AbstractService</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.AbstractService.java L184</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isInState(STATE.STARTED)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//enter the started state</span></span><br><span class="line">  <span class="keyword">synchronized</span> (stateChangeLock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stateModel.enterState(STATE.STARTED) != STATE.STARTED) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">        serviceStart();</span><br><span class="line">        <span class="keyword">if</span> (isInState(STATE.STARTED)) &#123;</span><br><span class="line">          <span class="comment">//if the service started (and isn&#x27;t now in a later state), notify</span></span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Service &quot;</span> + getName() + <span class="string">&quot; is started&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          notifyListeners();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In above <code>start</code> method, the service state transfers from <code>STATE.INITED</code> to <code>STATE.STARTED</code>, and <code>serviceStart</code> method which implemented in <code>YarnClientImpl</code> is invoked.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.client.api.impl.YarnClientImpl.java L105</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    rmClient = ClientRMProxy.createRMProxy(getConfig(),</span><br><span class="line">          ApplicationClientProtocol.class);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">super</span>.serviceStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>ApplicationClientProtocol</code> instance <code>rmClient</code> is created in <code>serviceStart</code>.</p>
<p>When I step into the <code>createRMProxy</code> method, I was shocked, it is really a lot of code. For simplicity, this method creates a RPC proxy link to the Resource Manager, and communicates according to the <code>ApplicationClientProtocol</code>, the implementation is in <code>ApplicationClientProtocolPBClientImpl</code> class.</p>
<p>We'll discuss what's under the hood of Hadoop/YARN RPC framework in later posts, believe in me. :)</p>
<h2 id="the-protocol-buffer-protocols">The Protocol Buffer Protocols</h2>
<p>After the Resource Manager proxy is established, the <code>Client</code> begins to ask questions to Resource Manager.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L335</span></span><br><span class="line">YarnClusterMetrics clusterMetrics = yarnClient.getYarnClusterMetrics();</span><br><span class="line">LOG.info(<span class="string">&quot;Got Cluster metric info from ASM&quot;</span></span><br><span class="line">    + <span class="string">&quot;, numNodeManagers=&quot;</span> + clusterMetrics.getNumNodeManagers());</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.client.api.impl.YarnClientImpl.java L242</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> YarnClusterMetrics <span class="title">getYarnClusterMetrics</span><span class="params">()</span> <span class="keyword">throws</span> YarnException,</span></span><br><span class="line"><span class="function">  IOException </span>&#123;</span><br><span class="line">  GetClusterMetricsRequest request =</span><br><span class="line">    Records.newRecord(GetClusterMetricsRequest.class);</span><br><span class="line">  GetClusterMetricsResponse response = rmClient.getClusterMetrics(request);</span><br><span class="line">  <span class="keyword">return</span> response.getClusterMetrics();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>By the <code>rmClient</code> proxy, the <code>Client</code> queries cluster metrics, running nodes and queue information from Resource Manager. The code path is clear, creates the input parameter, passes to method call, and gets the result.</p>
<p>But you might want to ask, what does <code>Records.newRecord</code> do?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.util.Records L30</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Records</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The default record factory</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RecordFactory factory =</span><br><span class="line">      RecordFactoryProvider.getRecordFactory(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">newRecord</span><span class="params">(Class&lt;T&gt; cls)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> factory.newRecordInstance(cls);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In <code>newRecord</code> method, by passing the <code>cls</code> parameter to <code>newRecordInstance</code> method call on <code>factory</code>, a new record is generated, with the <code>cls</code> type <code>GetClusterMetricsRequest</code>.</p>
<p>As we see in above code, the <code>factory</code> is created by calling <code>getRecordFactory</code> from <code>RecordFactoryProvider</code>.</p>
<p>Step into the <code>RecordFactoryProvider</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.factory.providers.RecordFactoryProvider.java L43</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RecordFactory <span class="title">getRecordFactory</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  String recordFactoryClassName = conf.get(</span><br><span class="line">      YarnConfiguration.IPC_RECORD_FACTORY_CLASS,</span><br><span class="line">      YarnConfiguration.DEFAULT_IPC_RECORD_FACTORY_CLASS);</span><br><span class="line">  <span class="keyword">return</span> (RecordFactory) getFactoryClassInstance(recordFactoryClassName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getFactoryClassInstance</span><span class="params">(String factoryClassName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Class&lt;?&gt; clazz = Class.forName(factoryClassName);</span><br><span class="line">    Method method = clazz.getMethod(<span class="string">&quot;get&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">    method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> method.invoke(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the <code>IPC_RECORD_FACTORY_CLASS</code> parameter is not set in configuration, the factory instance is created as <code>DEFAULT_IPC_RECORD_FACTORY_CLASS</code> which is "org.apache.hadoop.yarn.factories.impl.pb.RecordFactoryPBImpl" by calling its <code>get</code> method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.factories.impl.pb.RecordFactoryPBImpl L44</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RecordFactory <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The factory is got, then let's see how the <code>GetClusterMetricsRequest</code> instance is created by <code>newRecordInstance</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.factory.providers.RecordFactoryProvider.java L50</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">newRecordInstance</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">  Constructor&lt;?&gt; constructor = cache.get(clazz);</span><br><span class="line">  <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Class&lt;?&gt; pbClazz = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      pbClazz = localConf.getClassByName(getPBImplClassName(clazz));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(<span class="string">&quot;Failed to load class: [&quot;</span></span><br><span class="line">          + getPBImplClassName(clazz) + <span class="string">&quot;]&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      constructor = pbClazz.getConstructor();</span><br><span class="line">      constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      cache.putIfAbsent(clazz, constructor);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(<span class="string">&quot;Could not find 0 argument constructor&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Object retObject = constructor.newInstance();</span><br><span class="line">    <span class="keyword">return</span> (T)retObject;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getPBImplClassName</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">  String srcPackagePart = getPackageName(clazz);</span><br><span class="line">  String srcClassName = getClassName(clazz);</span><br><span class="line">  String destPackagePart = srcPackagePart + <span class="string">&quot;.&quot;</span> + PB_IMPL_PACKAGE_SUFFIX;</span><br><span class="line">  String destClassPart = srcClassName + PB_IMPL_CLASS_SUFFIX;</span><br><span class="line">  <span class="keyword">return</span> destPackagePart + <span class="string">&quot;.&quot;</span> + destClassPart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>At first, a class name is got from <code>getPBImplClassName</code>, since the parameter <code>clazz</code> is <code>GetClusterMetricsRequest</code>, the class name is <code>GetClusterMetricsRequestPBImpl</code>.</p>
<p>Then, gets the class constructor, and creates a new instance by calling below default constructor.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.api.protocolrecords.impl.pb.GetClusterMetricsRequestPBImpl.java L36</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GetClusterMetricsRequestPBImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  builder = GetClusterMetricsRequestProto.newBuilder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When you see the "Proto", "newBuilder", I think you might know now, it's <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/javatutorial">Protocol Buffer</a>.</p>
<p>Now we get the <code>GetClusterMetricsRequest</code> instance as a parameter to the <code>rmClient</code> proxy.</p>
<p>By calling the <code>getClusterMetrics</code>, a <code>GetClusterMetricsResponse</code> instance is returned as a response.</p>
<p>Let's step into the real Resource Manager proxy implementation.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.api.impl.pb.client.ApplicationClientProtocolPBClientImpl.java L146</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GetClusterMetricsResponse <span class="title">getClusterMetrics</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    GetClusterMetricsRequest request)</span> <span class="keyword">throws</span> YarnException,</span></span><br><span class="line"><span class="function">    IOException </span>&#123;</span><br><span class="line">  GetClusterMetricsRequestProto requestProto =</span><br><span class="line">      ((GetClusterMetricsRequestPBImpl) request).getProto();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GetClusterMetricsResponsePBImpl(proxy.getClusterMetrics(<span class="keyword">null</span>,</span><br><span class="line">      requestProto));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">    RPCUtil.unwrapAndThrowException(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The returned response is actually a <code>GetClusterMetricsResponsePBImpl</code> instance, in which has a <code>getClusterMetrics</code> interface implemented to translate the RPC result to native object.</p>
<p>Finally, the <code>getYarnClusterMetrics</code> method call on <code>yarnClient</code> is finished. Later method call such as <code>getNodeReports</code>, <code>getQueueInfo</code> is similar to <code>getYarnClusterMetrics</code>.</p>
<p>Let's continue the <code>run</code> method of <code>Client</code>.</p>
<h2 id="the-job-preparation">The Job Preparation</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L368</span></span><br><span class="line"><span class="comment">// Get a new application id</span></span><br><span class="line">YarnClientApplication app = yarnClient.createApplication();</span><br><span class="line">GetNewApplicationResponse appResponse = app.getNewApplicationResponse();</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>A <code>YarnClientApplication</code> instance is created through <code>yarnClient</code> proxy. If you really understand the above code flow for getting the cluster metrics, it is easy for you to look deep into the <code>createApplication</code> method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.client.api.YarnClientApplication.java L38</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">YarnClientApplication</span><span class="params">(GetNewApplicationResponse newAppResponse,</span></span></span><br><span class="line"><span class="function"><span class="params">                             ApplicationSubmissionContext appContext)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.newAppResponse = newAppResponse;</span><br><span class="line">  <span class="keyword">this</span>.appSubmissionContext = appContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> GetNewApplicationResponse <span class="title">getNewApplicationResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> newAppResponse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ApplicationSubmissionContext <span class="title">getApplicationSubmissionContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> appSubmissionContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A <code>YarnClientApplication</code> has two instance variables, a <code>GetNewApplicationResponse</code> and a <code>ApplicationSubmissionContext</code> instance, the latter is used to store all needed information of a job, which will be submitted to the Resource Manager.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L369</span></span><br><span class="line"><span class="comment">//** Get appContext from YarnClientApplication instance</span></span><br><span class="line">ApplicationSubmissionContext appContext = app.getApplicationSubmissionContext();</span><br><span class="line"><span class="comment">//** Get appId from appContext</span></span><br><span class="line">ApplicationId appId = appContext.getApplicationId();</span><br><span class="line"><span class="comment">//** Set application name to appContext,</span></span><br><span class="line"><span class="comment">//** which will be used to submit the job later</span></span><br><span class="line">appContext.setApplicationName(appName);</span><br><span class="line"></span><br><span class="line"><span class="comment">//** Create a ContainerLaunchContextPBImpl instance,</span></span><br><span class="line"><span class="comment">//** which obeys the ContainerLaunchContextProto protocol</span></span><br><span class="line">ContainerLaunchContext amContainer = Records.newRecord(ContainerLaunchContext.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//** Create a local resouces map for the application master</span></span><br><span class="line">Map&lt;String, LocalResource&gt; localResources = <span class="keyword">new</span> HashMap&lt;String, LocalResource&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//** Copy the application master jar to the hdfs</span></span><br><span class="line">FileSystem fs = FileSystem.get(conf);</span><br><span class="line">Path src = <span class="keyword">new</span> Path(appMasterJar);</span><br><span class="line">String pathSuffix = appName + <span class="string">&quot;/&quot;</span> + appId.getId() + <span class="string">&quot;/AppMaster.jar&quot;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//** Create a `LocalResourcePBImpl` instance, and add the AppMaster jar to it</span></span><br><span class="line">LocalResource amJarRsrc = Records.newRecord(LocalResource.class);</span><br><span class="line">...</span><br><span class="line">localResources.put(<span class="string">&quot;AppMaster.jar&quot;</span>,  amJarRsrc);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//** Copy the shell script to hdfs if exsits</span></span><br><span class="line">String shellPathSuffix = appName + <span class="string">&quot;/&quot;</span> + appId.getId() + <span class="string">&quot;/ExecShellScript.sh&quot;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Save local resource info into app master container launch context</span></span><br><span class="line">amContainer.setLocalResources(localResources);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the env variables to be setup in the env where the application master will be run</span></span><br><span class="line">Map&lt;String, String&gt; env = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">env.put(DSConstants.DISTRIBUTEDSHELLSCRIPTLOCATION, hdfsShellScriptLocation);</span><br><span class="line">env.put(DSConstants.DISTRIBUTEDSHELLSCRIPTTIMESTAMP, Long.toString(hdfsShellScriptTimestamp));</span><br><span class="line">env.put(DSConstants.DISTRIBUTEDSHELLSCRIPTLEN, Long.toString(hdfsShellScriptLen));</span><br><span class="line"></span><br><span class="line"><span class="comment">//** Add AppMaster.jar location to classpath</span></span><br><span class="line">StringBuilder classPathEnv = <span class="keyword">new</span> StringBuilder(Environment.CLASSPATH.$())</span><br><span class="line">  .append(File.pathSeparatorChar).append(<span class="string">&quot;./*&quot;</span>);</span><br><span class="line">...</span><br><span class="line">env.put(<span class="string">&quot;CLASSPATH&quot;</span>, classPathEnv.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">//** Save env to amContainer</span></span><br><span class="line">amContainer.setEnvironment(env);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the necessary command to execute the application master</span></span><br><span class="line">Vector&lt;CharSequence&gt; vargs = <span class="keyword">new</span> Vector&lt;CharSequence&gt;(<span class="number">30</span>);</span><br><span class="line">vargs.add(Environment.JAVA_HOME.$() + <span class="string">&quot;/bin/java&quot;</span>);</span><br><span class="line">...</span><br><span class="line"><span class="comment">// Set params for Application Master</span></span><br><span class="line">vargs.add(<span class="string">&quot;--container_memory &quot;</span> + String.valueOf(containerMemory));</span><br><span class="line">vargs.add(<span class="string">&quot;--num_containers &quot;</span> + String.valueOf(numContainers));</span><br><span class="line">vargs.add(<span class="string">&quot;--priority &quot;</span> + String.valueOf(shellCmdPriority));</span><br><span class="line"><span class="keyword">if</span> (!shellCommand.isEmpty()) &#123;</span><br><span class="line">  vargs.add(<span class="string">&quot;--shell_command &quot;</span> + shellCommand + <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!shellArgs.isEmpty()) &#123;</span><br><span class="line">  vargs.add(<span class="string">&quot;--shell_args &quot;</span> + shellArgs + <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">vargs.add(<span class="string">&quot;1&gt;&quot;</span> + ApplicationConstants.LOG_DIR_EXPANSION_VAR + <span class="string">&quot;/AppMaster.stdout&quot;</span>);</span><br><span class="line">vargs.add(<span class="string">&quot;2&gt;&quot;</span> + ApplicationConstants.LOG_DIR_EXPANSION_VAR + <span class="string">&quot;/AppMaster.stderr&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get final commmand</span></span><br><span class="line">StringBuilder command = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"><span class="keyword">for</span> (CharSequence str : vargs) &#123;</span><br><span class="line">  command.append(str).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; commands = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">commands.add(command.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">//** Save command to amContainer</span></span><br><span class="line">amContainer.setCommands(commands);</span><br><span class="line">...</span><br><span class="line"><span class="comment">//** Save amContainer to appContext</span></span><br><span class="line">appContext.setAMContainerSpec(amContainer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the priority for the application master</span></span><br><span class="line">Priority pri = Records.newRecord(Priority.class);</span><br><span class="line">pri.setPriority(amPriority);</span><br><span class="line">appContext.setPriority(pri);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the queue to which this application is to be submitted in the RM</span></span><br><span class="line">appContext.setQueue(amQueue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Submit the application to the applications manager</span></span><br><span class="line"><span class="comment">//** Again, use the rmClient proxy</span></span><br><span class="line">yarnClient.submitApplication(appContext);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> monitorApplication(appId);</span><br></pre></td></tr></table></figure>
<p>Now the job is deployed to hadoop cluster, and the running status is fetched by <code>monitorApplication</code> through <code>rmClient</code> proxy at every 1 second.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.zhengdong.me/2014/02/25/the-hadoop-2-dot-x-running-a-yarn-job-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dong Zheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Extra Cookies">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2014/02/25/the-hadoop-2-dot-x-running-a-yarn-job-1/" class="post-title-link" itemprop="url">The Hadoop 2.x - Running a YARN Job (1)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2014-02-25 13:49:00" itemprop="dateCreated datePublished" datetime="2014-02-25T13:49:00+08:00">2014-02-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In last <a href="/2014/02/20/the-hadoop-2-dot-x-introduction-to-yarn/">blog post</a>, a hadoop distribution is built to run a YARN job.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ bin/hadoop jar share/hadoop/yarn/hadoop-yarn-applications-distributedshell-2.2.0.jar \</span><br><span class="line">    org.apache.hadoop.yarn.applications.distributedshell.Client -jar \</span><br><span class="line">    share/hadoop/yarn/hadoop-yarn-applications-distributedshell-2.2.0.jar \</span><br><span class="line">    -shell_command <span class="string">&#x27;date&#x27;</span> -shell_args <span class="string">&quot;-u&quot;</span> -num_containers 2</span><br></pre></td></tr></table></figure>
<p>The <code>date -u</code> command is executed in Hadoop cluster by above script, we might conclude that there exists a dispatcher named <code>Client</code> in "hadoop-yarn-applications-distributedshell-2.2.0.jar", responsible for deploying a jar to cluster with parameters, such as shell command and args, and notify the cluster to execute the shell command.</p>
<p>To see what's in the rabbit hole, let's step into the <code>Client</code> source code.</p>
<p>Code snippets will be full of this post, to not confuse you, all comments added by me begin with <code>//**</code> instead of <code>//</code> or <code>/*</code> and the code can be cloned from <a target="_blank" rel="noopener" href="http://git.apache.org/hadoop-common.git/">Apache Git Repository</a>, commit id is <code>2e01e27e5ba4ece19650484f646fac42596250ce</code>.</p>
<h2 id="the-process-logic">The Process Logic</h2>
<p>Since the <code>Client</code> is started as a process, we'd better to look into the <code>main</code> method first.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L164</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Client client = <span class="keyword">new</span> Client();</span><br><span class="line">    LOG.info(<span class="string">&quot;Initializing Client&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">boolean</span> doRun = client.init(args);</span><br><span class="line">      <span class="keyword">if</span> (!doRun) &#123;</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">      ....</span><br><span class="line">    &#125;</span><br><span class="line">    result = client.run();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are three procedures, first, constructs a <code>Client</code> instance, then initializes it, and invokes the <code>run</code> method of it.</p>
<h2 id="the-client-instance">The Client Instance</h2>
<p>There are three constructors in <code>Client</code>, the <code>main</code> method calls the default one with no parameters.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L227</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> Exception  </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(<span class="keyword">new</span> YarnConfiguration());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The default constructor creates a <code>YarnConfiguration</code> instance and bypasses it to another constructor.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L194</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> Exception  </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(</span><br><span class="line">    <span class="string">&quot;org.apache.hadoop.yarn.applications.distributedshell.ApplicationMaster&quot;</span>,</span><br><span class="line">    conf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then sets "org.apache.hadoop.yarn.applications.distributedshell.ApplicationMaster" as <code>appMasterClass</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.Client.java L200</span></span><br><span class="line">Client(String appMasterMainClass, Configuration conf) &#123;</span><br><span class="line">  <span class="keyword">this</span>.conf = conf;</span><br><span class="line">  <span class="comment">//** Set appMasterMainClass</span></span><br><span class="line">  <span class="keyword">this</span>.appMasterMainClass = appMasterMainClass;</span><br><span class="line">  <span class="comment">//** This method call will create a YarnClientImpl instance</span></span><br><span class="line">  yarnClient = YarnClient.createYarnClient();</span><br><span class="line">  <span class="comment">//** Init the yarn client</span></span><br><span class="line">  yarnClient.init(conf);</span><br><span class="line">  <span class="comment">//** Create options for command parameters</span></span><br><span class="line">  <span class="comment">//** Will be parsed by GnuParser later</span></span><br><span class="line">  opts = <span class="keyword">new</span> Options();</span><br><span class="line">  opts.addOption(<span class="string">&quot;appname&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Application Name. Default value - DistributedShell&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;priority&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Application Priority. Default 0&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;queue&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;RM Queue in which this application is to be submitted&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;timeout&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Application timeout in milliseconds&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;master_memory&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Amount of memory in MB to be requested to run the application master&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;jar&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Jar file containing the application master&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;shell_command&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Shell command to be executed by the Application Master&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;shell_script&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Location of the shell script to be executed&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;shell_args&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Command line args for the shell script&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;shell_env&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Environment for shell script. Specified as env_key=env_val pairs&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;shell_cmd_priority&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Priority for the shell command containers&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;container_memory&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;Amount of memory in MB to be requested to run the shell command&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;num_containers&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;No. of containers on which the shell command needs to be executed&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;log_properties&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;log4j.properties file&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;debug&quot;</span>, <span class="keyword">false</span>, <span class="string">&quot;Dump out debug information&quot;</span>);</span><br><span class="line">  opts.addOption(<span class="string">&quot;help&quot;</span>, <span class="keyword">false</span>, <span class="string">&quot;Print usage&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>YarnClientImpl</code> extends from <code>YarnClient</code> which extends from <code>AbstractService</code> which implements from <code>Service</code>, the main job of it is to control the service life-cycle,</p>
<p>The <code>YarnClientImpl</code> is created and initialized.</p>
<p>Since the <code>init</code> method can't be found in <code>YarnClientImpl</code> as well as <code>YarnClient</code>, the actual <code>init</code> happens in <code>AbstractService</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.AbstractService.java L151</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (conf == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ServiceStateException(<span class="string">&quot;Cannot initialize service &quot;</span></span><br><span class="line">                                    + getName() + <span class="string">&quot;: null configuration&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isInState(STATE.INITED)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">synchronized</span> (stateChangeLock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enterState(STATE.INITED) != STATE.INITED) &#123;</span><br><span class="line">      setConfig(conf);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        serviceInit(config);</span><br><span class="line">        <span class="keyword">if</span> (isInState(STATE.INITED)) &#123;</span><br><span class="line">          <span class="comment">//if the service ended up here during init,</span></span><br><span class="line">          <span class="comment">//notify the listeners</span></span><br><span class="line">          notifyListeners();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        noteFailure(e);</span><br><span class="line">        ServiceOperations.stopQuietly(LOG, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">throw</span> ServiceStateException.convert(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It first checks whether the state <code>isInState</code> <code>STATE.INITED</code>, if not, <code>enterState(STATE.INITED)</code>, and calls the <code>serviceInit</code> method, when the state is successfully transferred to <code>STATE.INITED</code>, <code>notifyListeners()</code> is called.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.AbstractService.java L415</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    listeners.notifyListeners(<span class="keyword">this</span>);</span><br><span class="line">    globalListeners.notifyListeners(<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Exception while notifying listeners of &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot;: &quot;</span> + e,</span><br><span class="line">             e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//** org.apache.hadoop.service.ServiceOperations.java L139</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyListeners</span><span class="params">(Service service)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//take a very fast snapshot of the callback list</span></span><br><span class="line">  <span class="comment">//very much like CopyOnWriteArrayList, only more minimal</span></span><br><span class="line">  ServiceStateChangeListener[] callbacks;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    callbacks = listeners.toArray(<span class="keyword">new</span> ServiceStateChangeListener[listeners.size()]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//iterate through the listeners outside the synchronized method,</span></span><br><span class="line">  <span class="comment">//ensuring that listener registration/unregistration doesn&#x27;t break anything</span></span><br><span class="line">  <span class="keyword">for</span> (ServiceStateChangeListener l : callbacks) &#123;</span><br><span class="line">    l.stateChanged(service);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>notifyListeners</code> notifies all its listeners and global listeners to change their states correspondingly.</p>
<p>But, what is the STATE?</p>
<h2 id="the-state-model">The State Model</h2>
<p>Let's go back to the <code>YarnClient.createYarnClient()</code> method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.client.api.YarnClient.java L55</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> YarnClient <span class="title">createYarnClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  YarnClient client = <span class="keyword">new</span> YarnClientImpl();</span><br><span class="line">  <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>YarnClientImpl</code> instance is created.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.client.api.impl.YarnClientImpl.java L86</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">YarnClientImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>(YarnClientImpl.class.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.client.api.YarnClient.java L60</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">YarnClient</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.AbstractService.java L111</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  stateModel = <span class="keyword">new</span> ServiceStateModel(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bingo, that's the state model: <code>ServiceStateModel</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.ServiceStateModel.java L66</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ServiceStateModel</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(name, Service.STATE.NOTINITED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ServiceStateModel</span><span class="params">(String name, Service.STATE state)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.state = state;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The state model is simply a name state pair, the name is the service implementation class name.</p>
<p>The <code>isInState</code> checks the state value.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.ServiceStateModel.java L84</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInState</span><span class="params">(Service.STATE proposed)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> state.equals(proposed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>enterState</code> changes the state value after <code>checkStateTransition</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.ServiceStateModel.java L110</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Service.<span class="function">STATE <span class="title">enterState</span><span class="params">(Service.STATE proposed)</span> </span>&#123;</span><br><span class="line">  checkStateTransition(name, state, proposed);</span><br><span class="line">  Service.STATE oldState = state;</span><br><span class="line">  <span class="comment">//atomic write of the new state</span></span><br><span class="line">  state = proposed;</span><br><span class="line">  <span class="keyword">return</span> oldState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The state transferring is checked by looking up the statemap with current state, then return a boolean to indicate whether the state transition is valid, if it's invalid, the <code>checkStateTransition</code> throws <code>ServiceStateException</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.ServiceStateModel.java L125</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkStateTransition</span><span class="params">(String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Service.STATE state,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Service.STATE proposed)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isValidStateTransition(state, proposed)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ServiceStateException(name + <span class="string">&quot; cannot enter state &quot;</span></span><br><span class="line">                                    + proposed + <span class="string">&quot; from state &quot;</span> + state);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidStateTransition</span><span class="params">(Service.STATE current,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             Service.STATE proposed)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span>[] row = statemap[current.getValue()];</span><br><span class="line">  <span class="keyword">return</span> row[proposed.getValue()];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then what's in the statemap?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.service.ServiceStateModel.java L35</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span>[][] statemap =</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//                uninited inited started stopped</span></span><br><span class="line">    <span class="comment">/* uninited  */</span>    &#123;<span class="keyword">false</span>, <span class="keyword">true</span>,  <span class="keyword">false</span>,  <span class="keyword">true</span>&#125;,</span><br><span class="line">    <span class="comment">/* inited    */</span>    &#123;<span class="keyword">false</span>, <span class="keyword">true</span>,  <span class="keyword">true</span>,   <span class="keyword">true</span>&#125;,</span><br><span class="line">    <span class="comment">/* started   */</span>    &#123;<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>,   <span class="keyword">true</span>&#125;,</span><br><span class="line">    <span class="comment">/* stopped   */</span>    &#123;<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,  <span class="keyword">true</span>&#125;,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>That's the state model we are looking for. The current state is the row index, the proposed state is the column index, the value is whether the current state can be transfered to proposed state.</p>
<h2 id="the-command-initialization">The Command Initialization</h2>
<p>Go back again, to when the <code>YarnClientImpl</code> is about to be initialized, the <code>init</code> method of its super <code>AbstractService</code> calls the <code>serviceInit</code> method and the state is transfered to <code>STATE.INITED</code>.</p>
<p><code>YarnClientImpl</code> has implemented the <code>serviceInit</code> interface.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.client.api.impl.YarnClientImpl.java L96</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceInit</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.rmAddress = getRmAddress(conf);</span><br><span class="line">  statePollIntervalMillis = conf.getLong(</span><br><span class="line">      YarnConfiguration.YARN_CLIENT_APP_SUBMISSION_POLL_INTERVAL_MS,</span><br><span class="line">      YarnConfiguration.DEFAULT_YARN_CLIENT_APP_SUBMISSION_POLL_INTERVAL_MS);</span><br><span class="line">  <span class="keyword">super</span>.serviceInit(conf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The address of Resource Manager, <code>rmAddress</code> is assigned from the configuration instance.</p>
<p>Now the <code>Client</code> instance is created successfully, <code>init</code> method is invoked by <code>main</code> to initialize the instance.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//** org.apache.hadoop.yarn.applications.distributedshell.java L244</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line"></span><br><span class="line">  CommandLine cliParser = <span class="keyword">new</span> GnuParser().parse(opts, args);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  appName = cliParser.getOptionValue(<span class="string">&quot;appname&quot;</span>, <span class="string">&quot;DistributedShell&quot;</span>);</span><br><span class="line">  amPriority = Integer.parseInt(cliParser.getOptionValue(<span class="string">&quot;priority&quot;</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">  amQueue = cliParser.getOptionValue(<span class="string">&quot;queue&quot;</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  amMemory = Integer.parseInt(cliParser.getOptionValue(<span class="string">&quot;master_memory&quot;</span>, <span class="string">&quot;10&quot;</span>));</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  appMasterJar = cliParser.getOptionValue(<span class="string">&quot;jar&quot;</span>);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  shellCommand = cliParser.getOptionValue(<span class="string">&quot;shell_command&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The command line options is parsed, and assigned to instance variables for later usage.</p>
<p>The <code>Client</code> is ready to <code>run</code>.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/36/">36</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2010 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"><a target="_blank" rel="noopener" href="http://zhengdong.me">Dong Zheng</a></span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

  


</body>
</html>
